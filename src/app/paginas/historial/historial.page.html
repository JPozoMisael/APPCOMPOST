<app-main-header titulo="Historial"></app-main-header>

<ion-content class="historial-content">
  <div class="page-wrapper historial-wrapper">

    <!-- ================= RESUMEN SUPERIOR ================= -->
    <div class="summary-grid">
      <div class="summary-card">
        <div class="summary-label">Lecturas</div>
        <div class="summary-value">{{ totalLecturas }}</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Acciones auto</div>
        <div class="summary-value">{{ totalAcciones }}</div>
      </div>
      <div class="summary-card alert">
        <div class="summary-label">Alertas</div>
        <div class="summary-value">{{ totalAlertas }}</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Logs</div>
        <div class="summary-value">{{ totalLogs }}</div>
      </div>
    </div>

    <!-- ================= CARD PRINCIPAL ================= -->
    <ion-card class="main-card">

      <!-- TABS -->
      <ion-segment [(ngModel)]="tab" (ionChange)="onTabChange($event)" class="main-tabs">
        <ion-segment-button value="sensores"><ion-label>Sensores</ion-label></ion-segment-button>
        <ion-segment-button value="acciones"><ion-label>Acciones auto</ion-label></ion-segment-button>
        <ion-segment-button value="alertas"><ion-label>Alertas</ion-label></ion-segment-button>
        <ion-segment-button value="logs"><ion-label>Logs</ion-label></ion-segment-button>
      </ion-segment>

      <ion-card-content class="main-card-content">

        <!-- ================= SENSORES ================= -->
        <ng-container *ngIf="tab === 'sensores'">

          <!-- TOPBAR SENSORES -->
          <div class="tab-topbar">
            <div class="tab-topbar-left">
              <div class="tab-title">Sensores</div>
              <div class="tab-subtitle">
                {{ etiquetaCache }} · {{ fechaISO | date:'dd/MM/yyyy' }}
              </div>
            </div>

            <div class="tab-topbar-actions">
              <ion-button size="small" fill="outline" (click)="descargarSensoresCsv()">
                <ion-icon slot="start" name="download-outline"></ion-icon>
                CSV
              </ion-button>
              <ion-button size="small" fill="solid" (click)="descargarSensoresPdf()">
                <ion-icon slot="start" name="document-text-outline"></ion-icon>
                PDF
              </ion-button>
            </div>
          </div>

          <div class="layout-2cols">
            <!-- FILTROS -->
            <div class="filters-panel">
              <div class="filter-block">
                <label class="filter-label">Fecha</label>
                <ion-datetime-button datetime="fechaHistorial"></ion-datetime-button>

                <ion-modal [keepContentsMounted]="true" (ionDidDismiss)="onFechaConfirmada()">
                  <ng-template>
                    <ion-datetime
                      id="fechaHistorial"
                      presentation="date"
                      [(ngModel)]="fechaISO">
                    </ion-datetime>
                  </ng-template>
                </ion-modal>
              </div>

              <div class="filter-block">
                <label class="filter-label">Variable</label>
                <div class="var-chips">
                  <button class="var-chip" [class.active]="variable==='temperatura'" (click)="setVariable('temperatura')">Temperatura</button>
                  <button class="var-chip" [class.active]="variable==='humedadPromedio'" (click)="setVariable('humedadPromedio')">Humedad</button>
                  <button class="var-chip" [class.active]="variable==='NH3'" (click)="setVariable('NH3')">NH₃</button>
                  <button class="var-chip" [class.active]="variable==='CH4'" (click)="setVariable('CH4')">CH₄</button>
                </div>
              </div>
            </div>

            <!-- DATOS -->
            <div class="data-panel">
              <div class="resumen-card">
                <div class="resumen-grid">
                  <div class="resumen-item">Min: {{ resumenCache.min }}</div>
                  <div class="resumen-item">Prom: {{ resumenCache.prom }}</div>
                  <div class="resumen-item">Max: {{ resumenCache.max }}</div>
                </div>
              </div>

              <ion-card class="list-card">
                <ion-card-content>
                  <ion-item *ngFor="let l of lecturasFiltradas.length ? lecturasFiltradas : lecturas">
                    <ion-label>
                      <h3>{{ l.fechaView | date:'short' }}</h3>
                      <p>
                        T: {{ l.temperatura }} ·
                        H: {{ l.humedadPromedio }} ·
                        NH₃: {{ l.NH3 }} ·
                        CH₄: {{ l.CH4 }}
                      </p>
                    </ion-label>
                  </ion-item>
                </ion-card-content>
              </ion-card>
            </div>
          </div>
        </ng-container>

        <!-- ================= ACCIONES ================= -->
        <ng-container *ngIf="tab === 'acciones'">
          <div class="tab-topbar">
            <div>
              <div class="tab-title">Acciones automáticas</div>
              <div class="tab-subtitle">Historial lógica difusa</div>
            </div>
            <div class="tab-topbar-actions">
              <ion-button size="small" fill="outline" (click)="descargarAccionesCsv()">CSV</ion-button>
              <ion-button size="small" fill="solid" (click)="descargarAccionesPdf()">PDF</ion-button>
            </div>
          </div>

          <ion-card class="list-card">
            <ion-card-content>
              <ion-item *ngFor="let a of acciones">
                <ion-label>
                  <h3>{{ a.descripcion }}</h3>
                  <p>{{ a.estado }} · {{ a.fecha | date:'short' }}</p>
                </ion-label>
              </ion-item>
            </ion-card-content>
          </ion-card>
        </ng-container>

        <!-- ================= ALERTAS ================= -->
        <ng-container *ngIf="tab === 'alertas'">
          <div class="tab-topbar">
            <div>
              <div class="tab-title">Alertas</div>
              <div class="tab-subtitle">Historial de alertas</div>
            </div>
            <div class="tab-topbar-actions">
              <ion-button size="small" fill="outline" (click)="descargarAlertasCsv()">CSV</ion-button>
              <ion-button size="small" fill="solid" (click)="descargarAlertasPdf()">PDF</ion-button>
            </div>
          </div>

          <ion-card class="list-card">
            <ion-card-content>
              <ion-item *ngFor="let a of alertas">
                <ion-label>
                  <h3>{{ a.descripcion }}</h3>
                  <p>{{ a.fecha | date:'short' }}</p>
                </ion-label>
              </ion-item>
            </ion-card-content>
          </ion-card>
        </ng-container>

        <!-- ================= LOGS ================= -->
        <ng-container *ngIf="tab === 'logs'">
          <div class="tab-topbar">
            <div>
              <div class="tab-title">Logs</div>
              <div class="tab-subtitle">Eventos recientes</div>
            </div>
            <div class="tab-topbar-actions">
              <ion-button size="small" fill="outline" (click)="descargarLogsCsv()">CSV</ion-button>
              <ion-button size="small" fill="solid" (click)="descargarLogsPdf()">PDF</ion-button>
            </div>
          </div>

          <ion-card class="list-card">
            <ion-card-content>
              <ion-item *ngFor="let l of logs">
                <ion-label>
                  <h3>{{ l.accion }}</h3>
                  <p>{{ l.detalle }}</p>
                </ion-label>
              </ion-item>
            </ion-card-content>
          </ion-card>
        </ng-container>

      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
