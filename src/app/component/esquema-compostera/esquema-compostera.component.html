<div class="diagram-wrapper">
  <div class="diagram-header">
    <span class="hint">Estados en tiempo real (solo lectura)</span>
  </div>

  <svg
    class="diagram-svg"
    viewBox="0 0 980 420"
    xmlns="http://www.w3.org/2000/svg"
    preserveAspectRatio="xMidYMid meet"
  >
    <!-- ===== GRADIENTES / DEFINICIONES ===== -->
    <defs>
      <linearGradient id="tolvaGradient" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#e5e7eb" />
        <stop offset="100%" stop-color="#9ca3af" />
      </linearGradient>
      <linearGradient id="wireGradient" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="#94a3b8" />
        <stop offset="100%" stop-color="#cbd5f5" />
      </linearGradient>
    </defs>

    <!-- ========== MOTOR IZQUIERDA ========== -->
    <g
      class="node stepper-node motor-group"
      [ngClass]="{ on: isOn(motorEstado) }"
    >
      <!-- tarjeta -->
      <rect
        class="panel"
        x="40"
        y="110"
        rx="20"
        ry="20"
        width="150"
        height="90"
      />
      <!-- icono motor -->
      <circle class="stepper-disc" cx="85" cy="145" r="22" />
      <circle class="stepper-center" cx="85" cy="145" r="7" />

      <text x="115" y="138" class="node-title">Motor</text>
      <text x="115" y="158" class="node-text">
        Estado:
        <tspan class="state-text">{{ motorEstado }}</tspan>
      </text>
    </g>

    <!-- cable motor → compostera -->
    <line
      x1="190"
      y1="155"
      x2="270"
      y2="175"
      stroke="url(#wireGradient)"
      stroke-width="4"
      stroke-linecap="round"
    />

    <!-- ========== SENSORES DE HUMEDAD (ABAJO IZQ.) ========== -->
    <g transform="translate(90, 230)">
      <g class="soil-probe" transform="translate(0, 0)">
        <rect x="0" y="0" rx="8" ry="8" width="26" height="70" />
        <line x1="13" y1="70" x2="13" y2="90" />
      </g>
      <g class="soil-probe" transform="translate(40, 0)">
        <rect x="0" y="0" rx="8" ry="8" width="26" height="70" />
        <line x1="13" y1="70" x2="13" y2="90" />
      </g>
      <g class="soil-probe" transform="translate(80, 0)">
        <rect x="0" y="0" rx="8" ry="8" width="26" height="70" />
        <line x1="13" y1="70" x2="13" y2="90" />
      </g>
      <g class="soil-probe" transform="translate(120, 0)">
        <rect x="0" y="0" rx="8" ry="8" width="26" height="70" />
        <line x1="13" y1="70" x2="13" y2="90" />
      </g>
      <text x="0" y="100" class="soil-label">Sensores de humedad del suelo</text>
    </g>

    <!-- cable sensores → parte baja compostera -->
    <line
      x1="205"
      y1="250"
      x2="300"
      y2="260"
      stroke="url(#wireGradient)"
      stroke-width="3"
      stroke-linecap="round"
    />

    <!-- ========== COMPOSTERA CENTRAL ========== -->
    <g class="tolva-group">
      <!-- cuerpo -->
      <rect
        x="300"
        y="110"
        width="340"
        height="190"
        rx="40"
        ry="40"
        fill="url(#tolvaGradient)"
        stroke="#6b7280"
        stroke-width="3"
      />
      <text x="320" y="135" class="tolva-title">Compostera</text>

      <!-- sonar / nivel -->
      <g transform="translate(410, 80)">
        <rect
          class="sonar-box"
          x="0"
          y="0"
          rx="10"
          ry="10"
          width="90"
          height="34"
        />
        <circle class="sonar-circle" cx="24" cy="17" r="7" />
        <circle class="sonar-circle" cx="46" cy="17" r="7" />
        <circle class="sonar-circle" cx="68" cy="17" r="7" />
        <text x="22" y="50" class="sonar-label">Nivel</text>
      </g>

      <!-- DHT22 x2 -->
      <g transform="translate(600, 70)">
        <rect class="dht-body" x="0" y="0" rx="6" ry="6" width="26" height="40" />
        <rect class="dht-body" x="34" y="0" rx="6" ry="6" width="26" height="40" />
        <text x="0" y="56" class="dht-label">DHT22 x2</text>
      </g>
    </g>

    <!-- ========== ESCOTILLAS / SERVOS ARRIBA DERECHA ========== -->
    <g transform="translate(640, 165)">
      <!-- Escotilla A -->
      <g
        class="escotilla"
        [ngClass]="{ on: isOpen(servo1Estado) }"
        transform="translate(0, 0)"
      >
        <rect
          class="esc-panel"
          x="0"
          y="0"
          rx="16"
          ry="16"
          width="160"
          height="32"
        />
        <text x="10" y="20" class="esc-text">Escotilla A (Servo 1)</text>
        <text x="130" y="20" class="esc-state">
          {{ servo1Estado }}
        </text>
      </g>

      <!-- Escotilla B -->
      <g
        class="escotilla"
        [ngClass]="{ on: isOpen(servo2Estado) }"
        transform="translate(0, 40)"
      >
        <rect
          class="esc-panel"
          x="0"
          y="0"
          rx="16"
          ry="16"
          width="160"
          height="32"
        />
        <text x="10" y="20" class="esc-text">Escotilla B (Servo 2)</text>
        <text x="130" y="20" class="esc-state">
          {{ servo2Estado }}
        </text>
      </g>
      <text x="28" y="82" class="gas-label">Sensores de gas</text>
    </g>

    <!-- sondas de gas -->
    <g transform="translate(720, 150)">
      <g class="gas-probe">
        <rect x="0" y="0" rx="10" ry="10" width="22" height="44" />
        <line x1="11" y1="44" x2="11" y2="58" />
      </g>
      <g class="gas-probe" transform="translate(30, 0)">
        <rect x="0" y="0" rx="10" ry="10" width="22" height="44" />
        <line x1="11" y1="44" x2="11" y2="58" />
      </g>
    </g>

    <!-- ========== CABLES HACIA CARDS DERECHA (más separados) ========== -->
    <!-- Electroválvula (alto) -->
    <line
      x1="640"
      y1="205"
      x2="740"
      y2="205"
      stroke="url(#wireGradient)"
      stroke-width="3"
      stroke-linecap="round"
    />

    <!-- Ventilador 2 (medio) -->
    <line
      x1="640"
      y1="280"
      x2="740"
      y2="280"
      stroke="url(#wireGradient)"
      stroke-width="3"
      stroke-linecap="round"
    />

    <!-- Ventilador 1 (abajo) -->
    <line
      x1="640"
      y1="355"
      x2="740"
      y2="355"
      stroke="url(#wireGradient)"
      stroke-width="3"
      stroke-linecap="round"
    />

    <!-- ========== CARDS DERECHA: ELECTROVÁLVULA / VENTILADORES ========== -->

    <!-- ELECTROVÁLVULA -->
    <g
      class="node actuador-card interactive-panel"
      transform="translate(740, 165)"
    >
      <rect class="panel" x="0" y="0" rx="18" ry="18" width="210" height="80" />

      <!-- LED grande (cuadro) -->
      <rect
        class="relay-box"
        x="18"
        y="20"
        rx="6"
        ry="6"
        width="52"
        height="36"
        [attr.fill]="isOn(electrovalEstado) ? '#991b1b' : '#020617'"
      />
      <!-- LED redondo estado -->
      <circle
        class="led-outline"
        cx="82"
        cy="38"
        r="7"
        [attr.fill]="isOn(electrovalEstado) ? '#fca5a5' : '#fee2e2'"
      />

      <text x="110" y="36" class="node-title">Electroválvula</text>
      <text x="110" y="54" class="node-text">
        Estado:
        <tspan class="state-text">{{ electrovalEstado }}</tspan>
      </text>
    </g>

    <!-- VENTILADOR 2 -->
    <g
      class="node actuador-card interactive-panel"
      transform="translate(740, 245)"
    >
      <rect class="panel" x="0" y="0" rx="18" ry="18" width="210" height="80" />

      <rect
        class="relay-box"
        x="18"
        y="20"
        rx="6"
        ry="6"
        width="52"
        height="36"
        [attr.fill]="isOn(vent2Estado) ? '#1d4ed8' : '#020617'"
      />
      <circle
        class="led-outline"
        cx="82"
        cy="38"
        r="7"
        [attr.fill]="isOn(vent2Estado) ? '#bfdbfe' : '#e5e7eb'"
      />

      <text x="110" y="36" class="node-title">Ventilador 2</text>
      <text x="110" y="54" class="node-text">
        <tspan class="state-text">{{ vent2Estado }}</tspan>
      </text>
    </g>

    <!-- VENTILADOR 1 -->
    <g
      class="node actuador-card interactive-panel"
      transform="translate(740, 325)"
    >
      <rect class="panel" x="0" y="0" rx="18" ry="18" width="210" height="80" />

      <rect
        class="relay-box"
        x="18"
        y="20"
        rx="6"
        ry="6"
        width="52"
        height="36"
        [attr.fill]="isOn(vent1Estado) ? '#15803d' : '#020617'"
      />
      <circle
        class="led-outline"
        cx="82"
        cy="38"
        r="7"
        [attr.fill]="isOn(vent1Estado) ? '#bbf7d0' : '#e5e7eb'"
      />

      <text x="110" y="36" class="node-title">Ventilador 1</text>
      <text x="110" y="54" class="node-text">
        <tspan class="state-text">{{ vent1Estado }}</tspan>
      </text>
    </g>

    <!-- ========== BLOQUE DE LECTURAS (ABAJO CENTRO) ========== -->
    <g
      class="node readings-node interactive-panel"
      transform="translate(340, 285)"
    >
      <rect class="panel" x="0" y="0" rx="20" ry="20" width="280" height="90" />
      <text x="16" y="26" class="node-title">Lecturas</text>

      <text x="16" y="46" class="node-text">
        Temperatura:
        <tspan class="reading-value">{{ fmt(temp, ' °C', 0) }}</tspan>
      </text>
      <text x="16" y="66" class="node-text">
        Humedad:
        <tspan class="reading-value">{{ fmt(humedad, ' %', 0) }}</tspan>
      </text>

      <text x="150" y="46" class="node-text">
        NH₃:
        <tspan class="reading-value">{{ fmt(nh3, ' %', 0) }}</tspan>
      </text>
      <text x="150" y="66" class="node-text">
        CH₄:
        <tspan class="reading-value">{{ fmt(ch4, ' ppm', 0) }}</tspan>
      </text>
    </g>
  </svg>
</div>
